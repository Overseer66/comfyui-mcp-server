# ComfyUI MCP Server

A server implementation for integrating ComfyUI with MCP.

⚠️ **IMPORTANT: Required ComfyUI Server**
This MCP server requires an active ComfyUI server to function. You must either:
1. Host your own ComfyUI server
2. Have access to an existing ComfyUI server address

Without a running ComfyUI server, this MCP server will not work properly.

## Debugging

### ComfyUI Debugging
```bash
python src/test_comfyui.py
```

### MCP Debugging
```bash
mcp dev src/server.py
```

## Installation and Configuration

### ComfyUI Configuration
To modify ComfyUI host and port settings, edit `src/.env`:
```env
COMFYUI_HOST=localhost
COMFYUI_PORT=8188
```

### Custom Workflows
To add new tools, place your workflow JSON files in the `workflows` directory. Each new workflow must be declared as a new tool in the system.

### Built-in Tools

#### text_to_image
The built-in `text_to_image` tool returns only the URL of the generated image. To obtain the actual image, you can:
- Use the `download_image` tool to save the image
- Access the URL directly in your browser

#### download_image
You can use this tool to download images generated by other tools like `text_to_image`. Simply provide the image URL returned from the previous tool, and it will handle the download process for you.

### 1. Using UV (Recommended)
Configure `mcp.json`:
```json
{
  "mcpServers": {
    "comfyui": {
      "command": "uv",
      "args": [
        "--directory",
        "PATH/MCP/comfyui",
        "run",
        "--with",
        "mcp",
        "--with",
        "websocket-client",
        "--with",
        "python-dotenv",
        "mcp",
        "run",
        "src/server.py:mcp"
      ]
    }
  }
}
```

### 2. Using Docker
When using Docker, downloading images to a local folder using the `download_image` tool might be challenging since the Docker container doesn't share the same filesystem as your host machine.

When using Docker, consider these configuration points:
  1. Set `RETURN_URL=false` in `.env` to receive binary data instead of image URLs
  1. Set `COMFYUI_HOST` in `.env` to the appropriate host address (e.g., `host.docker.internal` or your server's IP)

Note: When configured to receive image data as bytes (RETURN_URL=false), Docker deployments with MCP may encounter errors due to the large size of image payload data exceeding response limits.


#### Build Docker Image
```bash
docker image build -t mcp/comfyui .
```

#### MCP Configuration
Configure `mcp.json`:
```json
{
  "mcpServers": {
    "comfyui": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-p",
        "3001:3000",
        "mcp/comfyui"
      ]
    }
  }
}
```

##### Using existing images
You can also use pre-built Docker images
Configure `mcp.json`:
```json
{
  "mcpServers": {
    "comfyui": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-p",
        "3001:3000",
        "overseer66/mcp-comfyui"
      ]
    }
  }
}
```


##### Using SSE Transport
You can also run the server remotely using SSE (Server-Sent Events) transport.

1. Run the SSE server using Docker:
    ```bash
    docker run -i --rm -p 8001:8000 overseer66/mcp-comfyui-sse
    ```
1. Configure `mcp.json`:
    
    Change localhost to your IP or domain
    ```json
    {
      "mcpServers": {
        "comfyui": {
          "url": "http://localhost:8001/sse" 
        }
      }
    }
    ```

Notice: When adding new workflows as tools, you need to rebuild and redeploy the Docker images to make them available.
